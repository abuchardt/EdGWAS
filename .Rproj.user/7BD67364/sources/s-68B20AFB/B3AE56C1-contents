\documentclass[usenames,dvipsnames]{beamer}
\usepackage[danish,UKenglish]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}

\usepackage{pgfpages}
%\setbeameroption{show only notes}


\usepackage{xcolor} %[usenames,dvipsnames,svgnames,table]
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{latexsym}
\input{/home/ann-sophie/wip/latex/commands}
\colorlet{mydarkblue}{myblue!30!black}

\usepackage{array}
\usepackage{calc}
\usepackage{booktabs,multirow}
\newcommand{\inserteqstrut}[1]{%
  \rlap{$\displaystyle#1$}%
  \phantom{\biggesteq}}
  
\usepackage{ulem}

\newcommand{\emp}[1]{\textcolor{RedOrange}{\textbf{#1}}}
\newcommand{\mathemp}[1]{\textcolor{RedOrange}{\boldsymbol{#1}}}


\beamertemplatenavigationsymbolsempty
\setbeamercolor{background canvas}{bg=eigengrau}
\setbeamercolor{normal text}{fg=white}
\setbeamercolor{frametitle}{fg=white}
\usefonttheme{serif}
\setbeamercolor{section in head/foot}{fg=white,bg=eigengrau}
\setbeamercolor{structure}{fg=white}
\setbeamerfont{footnote}{size=\tiny}

\makeatletter
\setbeamertemplate{headline}{%
    \begin{beamercolorbox}[ht=2.25ex,dp=3.75ex]{section in head/foot}
        \insertnavigation{\paperwidth}
    \end{beamercolorbox}%
}%
\makeatother

\usepackage{filecontents}
\begin{filecontents*}{literature.bib}
@Article{glinter,
  author = {Michael Lim and Trevor Hastie},
  title = {Learning Interactions via Hierarchical Group-Lasso Regularization},
  journal = {Journal of Computational and Graphical Statistics},
  volume = {24},
  number = {3},
  pages = {627--654},
  year = {2015}
}

@Article{lhi,
  title = {A Lasso for Hierarchical Interactions},
  author = {Jacob Bien and Jonathan Taylor and Robert Tibshirani},
  journal = {The Annals of Statistics},
  year = {2013},
  volume = {41},
  number = {3},
  pages = {1111--1141}
}
\end{filecontents*}

\setbeamertemplate{bibliography item}[triangle]
\setbeamercolor{bibliography item}{parent=palette primary}
\setbeamercolor*{bibliography entry title}{fg=RedOrange}%{parent=palette primary}
\setbeamercolor*{bibliography entry author}{parent=palette primary}
\setbeamercolor*{bibliography entry journal}{parent=palette primary}
\setbeamercolor*{bibliography entry note}{parent=palette primary}

%\usepackage[backend=bibtex]{biblatex}
%\bibliography{/home/ann-sophie/wip/latex/litteratur.bib}
%\setbeamertemplate{bibliography item}{}

\begin{document}

\begin{frame}
\centering \Large Identifying \emp{Interactions} \\ via \\ Hierarchical Lasso Regularisation

\vspace{.4in}
\normalsize Ann-Sophie Buchardt \& Claus Thorn Ekstr√∏m
\\ \small University of Copenhagen

\vspace{.4in}
\normalsize European Mathematical Genetics Meeting, 2019

%\includegraphics{EMGMlogo2}
\end{frame}


%
\section{Introduction}
\subsection{}

%
\begin{frame}
\only<1>{
\centering \Large Introduction
}

\only<2>{
  \transfade
  \begin{figure}\centering
  \begin{tikzpicture}
  \node (a) at (0,0)
      {\includegraphics[width=1.2in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}};
  \node[inner sep=0pt, minimum size=.4in] (b) at (-1,-3) {$\binom{p}{2}=\frac{1}{2}p(p-1)\quad$};
  \node[inner sep=0pt, minimum size=.4in] (c) at (3.5,2.5) {Gene-environment interactions};
  \node[inner sep=0pt, minimum size=.4in] (d) at (3.5,2) {Gene-gene interactions};
  \node[inner sep=0pt, minimum size=.4in] (e) at (-1,3) {$p \gg N$};
  \node[inner sep=0pt, minimum size=.4in] (f) at (0,-3.6) {\small 500K \textsc{snp} micro-array $\leadsto$ 125 billion pairwise interactions};
  %\node[inner sep=0pt, minimum size=.4in] (g) at (-4,1.5) {Reduce my impact on Earth?}; 
  \node[inner sep=0pt, minimum size=.4in] (g) at (-4,1) {Improve \textsc{fe}};
  \node[inner sep=0pt, minimum size=.4in] (h) at (-4,.5) {of Danish pigs}; 
  \node[inner sep=0pt, minimum size=.4in] (i) at (3,-2) {Shrinkage \& Selection}; 
  \draw[thick] (a.south) to[out=-90,in=40] (b.north) ;
  %\draw[thick] (c.west) to[out=-70,in=150] (a.north) ;
  \draw[thick] (d.south) to[out=-60,in=80] (a.east) ;
  \draw[thick] (e.south) to[out=-70,in=50] (a.north) ;
  \draw[thick] (h.south) to[out=-70,in=150] (a.west) ;
  \draw[thick] (i.north) to[out=50,in=-40] (a.south east) ;
  \end{tikzpicture}
  \end{figure}
}


\end{frame}

\note[itemize]{\item Hot topic: How can we reduce our impact on Earth? Well, we could try to improve the FE of the Danish pigs. \item So, we would like to breed pigs which require less feed to gain high meat and fat percentage, and to that end we look at genetic selection. \item So, we study the genes of Danish pigs which implies that we need to study data with many more variables, say $p$, than observations, say $N$. \item As if that wasn't enough, we study GE interactions and GG interactions, and if we have access to a 500K SNP micro-array, say, then we get 125 billion pairwise interactions.}



\begin{frame}{}%{\secname}
\transfade
\begin{table}\centering
\bgroup
\def\arraystretch{2}
\setlength\tabcolsep{10pt}
\begin{tabular}{cc | cc}
&& \multicolumn{2}{c}{\textbf{Gene $G_1$ for size}} \\ 
&& $G_1=0$ & $G_1=1$ \\ \hline 
\parbox[t]{.05in}{\multirow{2}{*}{\rotatebox[origin=c]{90}{\textbf{Gene $G_2$ for size}}}} & $G_2=0$ & \parbox[c][1in]{.8in}{\includegraphics[width=.8in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}} & \parbox[c]{1.0in}{\includegraphics[width=1.0in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}\\
& $G_2=1$ & \parbox[c][1.4in]{1.0in}{\includegraphics[width=1.0in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}} & \parbox[c]{1.6in}{\includegraphics[width=1.65in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}
\end{tabular}
\egroup
\end{table}
\end{frame}

%\begin{frame}{}%{\secname}
%\transfade
%\begin{table}\centering
%\bgroup
%\def\arraystretch{2}
%\setlength\tabcolsep{10pt}
%\begin{tabular}{cc | cc}
%&& \multicolumn{2}{c}{\textbf{Gene $G_1$ for size}} \\ 
%&& $G_1=0$ & $G_1=1$ \\ \hline 
%\parbox[t]{.05in}{\multirow{2}{*}{\rotatebox[origin=c]{90}{\textbf{Gene $G_2$ for size}}}} & $G_2=0$ & \parbox[c][1in]{.8in}{\only<1>{\includegraphics[width=.8in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}\only<2>{\centering 80 kg}} & \parbox[c]{1.0in}{\only<1>{\includegraphics[width=1.0in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}\only<2>{\centering 90 kg}}\\
%& $G_2=1$ & \parbox[c][1.4in]{1.0in}{\only<1>{\includegraphics[width=1.0in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}\only<2>{\centering 90 kg}} & \parbox[c]{1.6in}{\only<1>{\includegraphics[width=1.65in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}\only<2>{\centering 120 kg}}
%\end{tabular}
%\egroup
%\end{table}
%\end{frame}

\note[itemize]{\item Just to introduce and remind ourselves of the subject of interactions, let's say we look at two genes, $G_1$ and $G_2$, which may effect the size of a pig. \item Then, we may observe something like this: If neither $G_1$ nor $G_2$ are present, the pig is small; if only $G_1$ or $G_2$ is present, the pig is "normal", say; if both $G_1$ and $G_2$ are present, the pig is large. \item Now how do we find out which genes and interactions are relevant and which aren't?}

<<eval=FALSE, echo=FALSE>>=
library(ggplot2)
library(emojifont)
load.emojifont('OpenSansEmoji.ttf')

mycol <- "black" #"white"

par(family = "serif", ps=11, bg=NA, mar=c(0,0,0,0)) 
#pdf(paste0("/home/ann-sophie/wip/conferences/nbbc17/pigplot.pdf"), 
#    width=4, height=3, pointsize = 11)
data <- data.frame(x=c(10,10,30,30), y=c(10,30,10,30))
ggplot(data, aes(x, y)) + 
  geom_point() + 
  geom_point(data = data, colour = "red")
ggsave("/home/ann-sophie/wip/conferences/nbbc17/pigplot.pdf", plot = last_plot(), 
       #device = NULL, path = NULL, scale = 1, 
       width = 4, height = 3,
       #units = c("in", "cm", "mm"),
       #dpi = 300, limitsize = TRUE, ...
       )


par(family = "serif", ps=11, bg=NA, mar=c(0,0,0,0)) 
pdf(paste0("/home/ann-sophie/wip/conferences/nbbc17/pigplot.pdf"), 
    width=4, height=3, pointsize = 11)
plot(0, 0, axes=FALSE, type="n",
     xlab="", ylab="",asp=1)
text(0, 0, labels=emoji('pig'), cex=10, col=mycol, family='EmojiOne')
dev.off()


@

<<echo=FALSE, eval=FALSE>>=
colo <- "white"#"black"#
red <- green <- blue <- 153/255

cbPalette <- c(rgb(red,green,blue),
               rgb(42/255,103/255,236/255),
               rgb(255/255,95/255,24/255),
               rgb(153/255,150/255,50/255),
               rgb(156/255,85/255,141/255))

n <- 50
set.seed(2)
gene <- sample(0:2, size = n, replace = TRUE)
size <- sort(runif(n = n, min = 30, max = 70))
y <- 40 + 1*size + 4*gene + 12*gene*size + rnorm(n)
data <- data.frame(gene = factor(gene, labels = c("-","A or B","A and B")), size, y)

fit <- lm(y ~ size*gene, data=data)
summary(fit)

pdf("/home/ann-sophie/wip/lasso/interactions/pigHs.pdf",
    width=3.5, height=2.5, pointsize = 10)
par(family = "serif", ps=10, bg=NA, mar=c(4,4,1,1)) 
layout(matrix(c(1,2), 1, 2), width=c(4,1))
cols <- cbPalette[factor(gene)]
pch <- 20
plot(size, y, col=cols, bty="n", pch=pch,
     xlab="???", ylab="Weight", bty="n", axes=FALSE, col.lab=colo)
axis(1,col=colo, col.axis=colo)
axis(2,col=colo, col.axis=colo)
#abline(a=coef(fit)[1], b=coef(fit)[2], col="white", lty=2, lwd=2)
#abline(a=coef(fit)[1]+coef(fit)[3], b=coef(fit)[2]+coef(fit)[5], col="white", lty=2, lwd=2)
#abline(a=coef(fit)[1]+coef(fit)[4], b=coef(fit)[2]+coef(fit)[6], col="white", lty=2, lwd=2)
#points(size, y, col=cols, pch=pch)
par(mar=c(0,0,0,0)); plot.new()
legend("center",legend=c("0", "A | B", "A & B"), 
       pch=pch, col=cbPalette, title="Gene", bty="n", text.col=colo)
dev.off()

n <- 100
set.seed(2)
design <- data.frame(A = c(rep(0,n/4),rep(1,n/4), rep(0,n/4), rep(1,n/4)), 
                     B = c(rep(0,n/4),rep(0,n/4), rep(1,n/4), rep(1,n/4)),
                     AB = c(rep(0,n/4),rep(0,n/4), rep(0,n/4), rep(1,n/4)))
                           
beta <- cbind(rnorm(n,5,1), rnorm(n,6,1), rnorm(n,2,1))
y <-  rowSums(beta * design) + rnorm(n)
x <- factor(c(rep("-",n/4),rep("A",n/4), rep("B",n/4), rep("A and B",n/4)))
x <- factor(x,levels(x)[c(1,2,4,3)])
plot(y)

pdf("/home/ann-sophie/wip/lasso/interactions/piGHs.pdf",
    width=3, height=2.5, pointsize = 10)
par(family = "serif", ps=10, bg=NA, mar=c(4,4,1,1)) 
boxplot(y ~ x, frame=FALSE, border=colo, axes=FALSE)
axis(1,col=colo, col.axis=colo, at=1:4, labels=levels(x), font=3)
axis(2,col=colo, col.axis=colo)
dev.off()

data <- data.frame(gene = factor(gene, labels = c("-","A or B","A and B")), size, y)

plot(y)

fit <- lm(y ~ size*gene, data=data)
summary(fit)

@




\note[itemize]{\item Now, how do we model this?}

\section{Methods}
\subsection{}


\begin{frame}
\only<1>{
  \begin{center}
  \Large Methods
  \end{center}
}
\only<2>{
\transfade
  \begin{center}
  \Large Linear regression model with main effects and interactions
  \end{center}
  
  \begin{align*}
    \by_i &= \bbeta_0 + \bX_{iG_1}\bbeta_{G_1} + \bX_{iG_2}\bbeta_{G_2} + \bX_{iG_1}\bX_{iG_2}\bTheta_{G_1:G_2} + \bepsilon_i, 
  \end{align*}
  \hfill \raggedright $i=1,\ldots,N$
}


\end{frame}

\note[itemize]{\item Well, we may use linear regression model with main effects and interactions. \item Here, $\by$ is the outcome, that is, the size of the pig, $\bX$ is the features, the presence of a certain gene, $\bbeta_0$ is the intercept, $\bbeta_{G_1}$ and $\bbeta_{G_2}$ are coefficients for the main effects, $\bTheta_{G_1:G_2}$ is the coefficient for the interaction, and $\bepsilon$ is the error term.}


\begin{frame}{}%{\secname}
\transfade
\begin{overlayarea}{\textwidth}{\textheight}
\vspace{.4in}%\vfill
\begin{center}
\Large Pairwise interaction model
\end{center}
\vspace{.4in}%\vfill
\begin{align*}
  \by_i
  &= \sum_{j=1}^p \bX_{ij}\bbeta_{j} + \sum_{j<k} \bX_{ij}\bX_{ik}\bTheta_{jk} + \bepsilon_i,\qquad i=1,\ldots,N
\end{align*}




%\vspace{.8in}%\vfill
\begin{tabular}{rl}
\only<2>{\makebox[\widthof{Pure main effects }][r]{Strong hierarchy}}%
\only<2>:&%
\only<2>{\makebox[\widthof{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$ and $\bhatbeta_k\neq 0$}][l]{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$ and $\bhatbeta_k\neq 0$}}%
\end{tabular}
%\vfill
\end{overlayarea}
\end{frame}

\note[itemize]{\item In the case of $p$ features, the pairwise interaction model looks like this. }

\note[itemize]{\item Now, whenever we wish to include interactions, we need to consider which interaction to include, and that leads us to the concept of hierarchy... \item ...If, for example we assume "strong hierarchy", then we only include interactions if both corresponding main effects are included.}

\begin{frame}<presentation:0>%{}%{\secname}
\transfade
\begin{table}\centering
\bgroup
\def\arraystretch{2}
\setlength\tabcolsep{10pt}
\begin{tabular}{cc | cc}
&& \multicolumn{2}{c}{\textbf{Gene $G_1$ for size}} \\ 
&& $G_1=0$ & $G_1=1$ \\ \hline
\parbox[t]{.05in}{\multirow{2}{*}{\rotatebox[origin=c]{90}{\textbf{Gene $G_2$ for size}}}} & $G_2=0$ & \parbox[c]{.8in}{\includegraphics[width=.8in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}} & \parbox[c]{1in}{\includegraphics[width=1in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}\\
& $G_2=1$ & \parbox[c]{1in}{\includegraphics[width=1in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}} & \parbox[c]{1.6in}{\includegraphics[width=1.6in, keepaspectratio]{/home/ann-sophie/wip/conferences/nbbc17/pig}}
\end{tabular}
\egroup
\end{table}
\end{frame}

\note[itemize]{\item In the 2 factor design, that could mean that the absence of both genes results in a small pig, the presence of either $G_1$ or $G_2$ results in a larger pig and the presence of both $G_1$ and $G_2$ results in a very large pig -- so large that the effects of the genes are not additive.}

\begin{frame}{}%{\secname}
\transfade
\begin{overlayarea}{\textwidth}{\textheight}
\vspace{.4in}%\vfill
\begin{center}
\Large Pairwise interaction model
\end{center}
\vspace{.4in}%\vfill
\begin{align*}
  \by_i
  &= \sum_{j=1}^p \bX_{ij}\bbeta_{j} + \sum_{j<k} \bX_{ij}\bX_{ik}\bTheta_{jk} + \bepsilon_i
\end{align*}

%\vfill
\begin{tabular}{rl}
\only<1>{\makebox[\widthof{Pure main effects }][r]{Weak hierarchy}}%
\only<2>{\makebox[\widthof{Pure main effects }][r]{Anti-hierarchy}}%
\only<4>{\makebox[\widthof{Pure main effects }][r]{Pure interactions}}%
\only<3>{\makebox[\widthof{Pure main effects }][r]{Pure main effects}}%
\only<5>{\makebox[\widthof{Pure main effects }][r]{No hierarchy}}%
\only<1-5>:&%
\only<1>{\makebox[\widthof{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$ and $\bhatbeta_k\neq 0$}][l]{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$  or  $\bhatbeta_k\neq 0$}}%
\only<2>{\makebox[\widthof{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$ and $\bhatbeta_k\neq 0$}][l]{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j = 0$  and  $\bhatbeta_k = 0$}}%
\only<4>{\makebox[\widthof{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$ and $\bhatbeta_k\neq 0$}][l]{$\bhatbeta_j = 0 \quad\forall j=1,\ldots,p$}}%
\only<3>{\makebox[\widthof{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$ and $\bhatbeta_k\neq 0$}][l]{$\boldsymbol{\hat\Theta}_{jk} = 0 \quad\forall j,k=1,\ldots,p$}}%
\only<5>{\makebox[\widthof{$\boldsymbol{\hat\Theta}_{jk} \neq 0 \ \Rightarrow\  \bhatbeta_j\neq 0$ and $\bhatbeta_k\neq 0$}][l]{No restrictions \phantom{$\bhatbeta_j$}}}%
\end{tabular}
\end{overlayarea}
%\vfill
\end{frame}

\note[itemize]{\item Now, if we assume "weak hierarchy", then we include interactions if only one corresponding main effect is included... \item ... If we assume anti-hierarchy, we only include the interactions if none of the corresponding main effects are included... \item ... If we assume pure main effects, we never include the interactions... \item If we assume only interactions, we never include main effects... \item ... And, finally, if we assume no hierarchy, there is no restrictions on the pairwise interaction model.}



\begin{frame}
\transfade
\only<1>{\centering \Large Make \emp{lasso} produce sparse interaction models that honour hierarchy restrictions}
\only<2>{
  \begin{align*}
   \underset{\bbeta\in\mathbb{R}^{p},\bTheta\in\mathbb{R}^{p\times p}}{\text{minimise}} \left\{q(\bbeta,\bTheta) + \lambda \sum_{j=1}^p |\bbeta_j| + \lambda \sum_{j<k} |\bTheta_{jk}|\right\}
  \end{align*}
  
  \begin{align*}
    q(\bbeta,\bTheta)
    =\frac{1}{2N}\sum_{i=1}^N\left(\by_i-\sum_{j=1}^p \bX_{ij}\bbeta_j - \sum_{j<k}\bX_{ij}\bX_{ik}\bTheta_{jk}\right)^2
  \end{align*}
}
\end{frame}

\note[itemize]{\item Since we are in the case of $p>>N$ we can't use the ordinary least squares method for estimating the parameters. Instead, we have looked at the lasso, to obtain sparse interaction models, which honour hierarchical restrictions... \item ... The usual lasso solves this optimisation problem, where the first term, $q$, is the loss function, the second term is a penalty on the size of the parameters for the main effects, and the last term is a penalty on the size of the parameters for the interaction effects.}

\begin{frame}{}%{\secname}
\transfade
%\raggedright 
%\printbibliography
\raggedright
\nocite{*}
\bibliographystyle{plain}
\bibliography{/home/ann-sophie/wip/conferences/nbbc17/literature}
\end{frame}

\note[itemize]{\item To take into account the hierarchical structures Bien, Taylor and Tibshirani add a set on convex constraints on $\bTheta$ to the lasso. \item Lim and Hastie use the group lasso.}



\begin{frame}{}%{\secname}
\transfade

\only<1>{
  \centering \Large 2-Step Procedure
}

\only<2-3>{
  \only<2>{\bf Step 1}\only<3>{\bf Step 2}
  \begin{overlayarea}{\textwidth}{\textheight}
  %
  \newcommand{\biggesteq}{\sum_{\substack{j<k\\j,k\in\mathemp{\mathcal{I}_{\text{H}}^{(\lambda_1)}}}} \bX_{ij}\bX_{ik}\bTheta_{jk} + \bepsilon_i}
  %\newcommand{\biggesteq}{\sum_{j\in\mathcal{M}_{\text{H}}^{(\lambda_1)}} \bX_{ij}\bbeta_{j} + \sum_{\substack{j<k\\j,k\in\mathcal{I}_{\text{H}}^{(\lambda_1)}}} \bX_{ij}\bX_{ik}\bTheta_{jk} + \bepsilon_i}
  %
  \begin{align*}
    \only<2-3>{\by_i = \sum_{j\in\mathemp{\mathcal{M}}} \bX_{ij}\bbeta_{j} + }
    \only<2>{\inserteqstrut{\bepsilon_i}}
    \only<3>{\inserteqstrut{\biggesteq}}
  \end{align*} 
  %
  \newcommand{\biggesteqq}{\left.- \sum_{\substack{j<k\\j,k\in\mathcal{I}_{\text{H}}^{(\lambda_1)}}} \bX_{ij}\bX_{ik}\bTheta_{jk}\right)^2 }
  %
  \begin{align*}
    \only<2-3>{\underset{\bbeta\in\mathbb{R}^{p}}{\text{minimise}} 
    \left\{\frac{1}{2N}\sum_{i=1}^N\left(\by_i - \sum_{\substack{j\in\mathcal{M}\\\phantom{\mathcal{I}_{\text{H}}^{(\lambda_1)}}}} \bX_{ij}\bbeta_j \right.\right.}
    \only<2>{\inserteqstrut{\left.\left.\vphantom{\sum_{\substack{j\in\mathcal{M}\\\phantom{\mathcal{I}_{\text{H}}^{(\lambda_1)}}}}}\right)^2 + \lambda_1 \sum_{\substack{j\in\mathcal{M}\\\phantom{j,k\in\mathcal{I}_{\text{H}}^{(\lambda_1)}}}} |\bbeta_j| \right\}}} 
    \only<3>{\inserteqstrut{\biggesteqq}\\
    \left. + \lambda_2 \sum_{j\in\mathcal{M}} \bgamma_j|\bbeta_j| + \lambda_2 \sum_{\substack{j<k\\j,k\in\mathcal{I}_{\text{H}}^{(\lambda_1)}}} |\bTheta_{jk}| \right\}}
  \end{align*}
  \end{overlayarea}
}

\end{frame}

\note[itemize]{\item We propose a two-step procedure: \item In the first step we include only the main effects and apply the usual lasso. Here $\mathcal{M}$ is the set of indexes for all the main effects. \item In the second step we include the main effects and the interactions, subject to one of the hierarchy restrictions, and, then, apply the adaptive lasso with the penalty modifier, $\bgamma$, depending on the given restriction. Here $\mathcal{I}_H$ is the set of interactions to be included in the model subject to a hierarchy restriction.}


\begin{frame}<presentation:0>
\transfade
\centering Example: Weak hierarchy \par
\begin{align*}
  \mathcal{M}^{(\lambda_1)}=\left\{k:\bhatbeta_k^{(\lambda_1)}\neq 0\right\}
\end{align*}
%\begin{align*}
%  \mathcal{M}_{\text{H}_{\text{W}}}^{(\lambda_1)}=\left\{k:\bhatbeta_k^{(\lambda_1)}\neq 0\right\}
%\end{align*}
\begin{align*}
  \mathcal{I}_{\text{H}_{\text{W}}}^{(\lambda_1)}=\left\{j,k:\bhatbeta_j\in\mathcal{M}^{(\lambda_1)}\lor\bhatbeta_k\in\mathcal{M}^{(\lambda_1)}\right\}
\end{align*}
\begin{align*}
  \bgamma_j=\left\{\begin{array}{ll}
  0 & j\in \mathcal{M}^{(\lambda_1)}\\
  1 & \text{otherwise}
  \end{array}\right., \qquad j=1,\ldots,p
\end{align*}
\end{frame}

\note[itemize]{\item If, for example, we assume strong hierarchy, and the set of main effects is estimated by $\mathcal{M}^{\lambda_1}$, and the set of interactions is estimated by $\mathcal{I}_{H_W}^{(\lambda_1)}$. The penalty modifier is defined to ensure that the main effects selected in the first step are never (or always) penalised in the second step. }



\note[itemize]{\item To study the advantages and disadvantages of the two-step procedure under the different hierarchical restrictions we simulate.}

%
\section{Results}
\subsection{}


%
\begin{frame}{}%{\secname}
\transfade
\only<1>{\centering \Large Results: Simulation Study}

\only<2>{
  \centering
  
  $\bX\in\{0,1,2\}^{\Sexpr{N=200;N} \times \Sexpr{p=600;p}}$ i.i.d. \\ 
  \vfill 
  
  $\bbeta_1$ and $\bbeta_2$ zero/non-zero  depending on \emp{hierarchy} \\
  $\bTheta_{12}$ non-zero
  \vfill 
  $\by\in\mathbb{R}^{\Sexpr{N=200;N}} \qquad \by=\bX\bbeta+\bepsilon \qquad \epsilon_i\sim\mathcal{N}(0,1)$ 
}

\end{frame}

\note[itemize]{\item We generate 600 3-way categorical features, resulting in 179700 pairwise interactions. Depending on the assumed "true" hierarchy there are one or two main effects and/or one interaction. From the features we generate 200 observations, where $\bepsilon$ is standard Gaussian noise. We create a sparse problem by letting all coefficient except $\bbeta_1, \bbeta_2$, and $\bTheta_{1:2}$ be zero.}

\begin{frame}
\transfade
\begin{table}\centering
\begin{tabular}{rl}
\toprule
\multicolumn{2}{l}{\textbf{Step 1}} \\ \midrule
1.& Apply lasso to main effects using \texttt{cv.glmnet};\\
2.& Compute the set of selected main effects, $\mathcal{M}^{(\lambda_1)}$. \\
\bottomrule
\end{tabular}
\end{table}

\begin{table}\centering
\begin{tabular}{rl}
\toprule
\multicolumn{2}{l}{\textbf{Step 2}} \\ \midrule
1.& Assume a hierarchy $\textsc{h}$ (\hs{} or \hw);\\
2.& Compute the set of allowed interactions $\mathcal{I}_{\text{H}}^{(\lambda_1)}$;\\
3.& Define a suitable vector of penalty factors $\bgamma$;\\
4.& Apply adaptive lasso using \texttt{cv.glmnet}.\\
\bottomrule
\end{tabular}
\end{table}
\end{frame}


\begin{frame}
\transfade\centering
Repeat 100 times to reduce residual variation.
\vfill

Calculate the average false discovery rate for \emp{interactions}
\begin{align*}
  i\textsc{fdr}={\frac{V^{(i)}}{V^{(i)}+S^{(i)}}}.
\end{align*}
  
\end{frame}

\note[itemize]{\item To reduce the residual variation we repeat the sampling of the outcome as well as the fitting using the two-step procedure 100 times. \item We calculate the average false discovery rate for interactions. Here $V^{(i)}$ is the number of false discoveries of interactions and $S^{(i)}$ is the number of true discoveries of interactions.}

\graphicspath{{/home/ann-sophie/wip/lasso/interactions/}}
\begin{frame}{}%{\secname}
\transfade
\only<1>{\centering \Large Data Generating Process: Strong Hierarchy}
\only<2>{
  \begin{overlayarea}{\textwidth}{\textheight}
  \begin{figure}
  \centering
  \includegraphics{plot2x2whitebet12bet1Strong100600200}
  %\only<1>{\includegraphics{PLOTwhitebet12bet1StrongS1100600200}}
  %\only<2>{\includegraphics{PLOTwhitebet12bet1StrongW10100600200}}
  %\only<3>{\includegraphics{PLOTwhitebet12bet1StrongA10100600200}}
  %\only<4>{\includegraphics{PLOTwhitebet12bet1StrongN1100600200}}
  \end{figure}
  \end{overlayarea}
}
\end{frame}



\graphicspath{{/home/ann-sophie/wip/lasso/interactions/}}
\begin{frame}<presentation:0>{}%{\secname}
\transfade
\only<1>{\centering \Large Data Generating Process: Weak Hierarchy}
\only<2>{
  \begin{overlayarea}{\textwidth}{\textheight}
  \begin{figure}
  \centering
  \includegraphics[height=\textheight]{PLOTwhitebet12bet1Weak100600200}
  %\only<1>{\includegraphics{PLOTwhitebet12bet1WeakS10100600200}}
  %\only<2>{\includegraphics{PLOTwhitebet12bet1WeakW10100600200}}
  %\only<3>{\includegraphics{PLOTwhitebet12bet1WeakA10100600200}}
  %\only<4>{\includegraphics{PLOTwhitebet12bet1WeakN10100600200}}
  \end{figure}
  \end{overlayarea}
}
\end{frame}


<<eval=FALSE, echo=FALSE>>=
rm(list=ls())
gc()

setwd("/home/ann-sophie/wip/lasso/interactions/")

p <- 600; n <- 200; strat <- "bet12"; xaxis <- "bet1"; B <- 100; W <- 10

truth <- c("Strong")
hier <- c("Strong", "No") 


colo <- "white"
red <- green <- blue <- 153/255

cbPalette <- c(colo,
               rgb(red,green,blue),
               rgb(42/255,103/255,236/255),#54/255,90/255,165/255),#86/255,180/255,233/255), 
               rgb(153/255,150/255,50/255),#235/255,164/255,0), 
               rgb(156/255,85/255,141/255),#186/255,85/255,211/255), 
               rgb(255/255,95/255,24/255))#190/255,71/255,0))  

cbPaletteT <- c(rgb(1,1,1,.2),
                rgb(red,green,blue,.2), 
               rgb(42/255,103/255,236/255,.2),#54/255,90/255,165/255,.2),#86/255,180/255,233/255,.2), 
               rgb(153/255,150/255,50/255,.2), 
               rgb(156/255,85/255,141/255,.2),#186/255,85/255,211/255,.2),  
               rgb(255/255,95/255,24/255,.2))#190/255,71/255,0,.2))
width <- 4.5
height <- 3.2


#########
# Truth #
#########
for(r in 1:length(truth)){
  xlabs <- ifelse(truth[r]=="Strong", expression(paste(beta[1], " = ", beta[2], "      ")),
                  ifelse(truth[r]=="Weak", expression(paste(beta[1], "            ")),
                         ifelse(truth[r]=="Anti", expression(beta[3]),
                                "")))
  
  pdf(paste0("/home/ann-sophie/wip/lasso/interactions/plot2x2",
             colo,strat,xaxis,truth[r],B,p,n,".pdf"), 
      width=width, height=height, pointsize = 11)
  par(family = "serif", ps=10, oma=c(3,3,0,1), bg=NA) 
  layout(matrix(c(1,2,3,3,4,4), 3, 2, byrow = TRUE), 
         height=c(6,1,2))
  par(mar=c(2,2,2,1))
  for(h in 1:length(hier)){
    W <- 10
    setwd("/home/ann-sophie/wip/lasso/interactions/finalsimulations/")
    bet1 <- seq(0.1,1.1,by=0.1)
    bet2 <- NULL
    bet12 <- seq(0.1,1.1,by=0.2)
    
    if(hier[h]=="No") scree <- "GSR"; 
    
    load(file=paste0("catStep2", strat,xaxis,truth[r],hier[h],W,B,p,n,".RData"))
    plot(1, type="n", xlim=range(eval(parse(text=xaxis))), ylim=c(0,1),
         xlab="", ylab="", bty="n", axes=FALSE, col.lab=colo)
    axis(1,col=colo, col.axis=colo, tck=-0.05)
    axis(2,col=colo, col.axis=colo, tck=-0.05)
    for(EX in 1:length(eval(parse(text=strat)))){
      lines(eval(parse(text=xaxis)), STEP2$IFDR[[EX]]$ifdr, lty=1, col=cbPalette[EX])  
      ciu <- STEP2$IFDR[[EX]]$ifdr + 2*STEP2$IFDR[[EX]]$isem
      cil <- STEP2$IFDR[[EX]]$ifdr - 2*STEP2$IFDR[[EX]]$isem
      idx <- which(!is.na(STEP2$IFDR[[EX]]$ifdr))
      polygon(c(eval(parse(text=xaxis))[idx], 
                rev(eval(parse(text=xaxis))[idx])), 
              c(ciu[idx],rev(cil[idx])),
              col=cbPaletteT[EX], border=NA)  
      lines(eval(parse(text=xaxis)), STEP2$IFDR[[EX]]$ip, lty=3, lwd=2, col=cbPalette[EX])
    }
    leg <- ifelse(hier[h]=="Anti", "-hierarchy", " hierarchy")
    mtext(paste0(hier[h], leg), # (", round(STEP2$ETIM), "min., B = ", B,")"), 
          side=3, font=1, outer=FALSE, col=colo, line=0, cex=.8)
    #rm(STEP2)
  }
  mtext("                               iFDR", 
        side=2, outer=TRUE, line=2, font=1, col=colo, cex=.9)
  
  par(mar=c(0,0,0,0))
  plot.new()
  legend("center", legend=xlabs, text.col=colo, 
         bty="n", lwd=0)
  #mtext(xlabs, side=1, outer=TRUE, line=2, font=1, col=colo, cex=.9)
  
  par(mar=c(0,0,0,0))
  plot.new()
  legend("center", legend=eval(parse(text=strat)), text.col=colo, ncol=6,
         bty="n", lty=4, lwd=2, col=cbPalette, title=expression(paste(beta[1:2])))
  dev.off()
}
@



<<echo=FALSE, eval=FALSE>>=
library(readr)
library(tidyverse)
library(magrittr)
source(file = "/home/ann-sophie/wip/data/mouse/importMouseData.R")

# Features
# Convert the data frame of allelle frequencies to a numeric matrix

chrOfInterest <- unique(dataSNP$Chr)
snpsOfInterest <- which(apply(genoData[,-(1:3)], 1, var) != 0)
miceOfInterest <- which(dataInd$X2 %in% dataPheno$SUBJECT.NAME) #[dataPheno$sex == "F"])

snpMatrix <- t(sapply(genoData[snpsOfInterest,-(1:3)], as.numeric))[miceOfInterest, ]
colnames(snpMatrix) <- genoData$X1[snpsOfInterest]


# Return a vector of outcome
pheno <- 10
outcomeVar <- names(dataPheno[,pheno])
y <- dataPheno[miceOfInterest, outcomeVar] %>% pull

# Remove missing data
naYs <- which(is.na(y))
y <- y[-naYs]

# Remove collinear data
library(MESS)
tt <- select_variables_using_cor(snpMatrix, .99)
X <- snpMatrix[-naYs, tt]
save(X, y, snpMatrix, outcomeVar, file = paste0("/home/ann-sophie/wip/journalclub/Xy",pheno))


# Data dimensions
n <- length(y)
p <- ncol(X)

W <- 10

@

<<echo=FALSE>>=
pheno <- 10
load(file = paste0("/home/ann-sophie/wip/journalclub/Xy", pheno))

# Data dimensions
n <- length(y)
p <- ncol(X)

W <- 10
@

<<eval=FALSE, echo=FALSE>>=
colo <- "white"
red <- green <- blue <- 153/255

cbPalette <- c(rgb(red,green,blue),
               rgb(42/255,103/255,236/255),#54/255,90/255,165/255),#86/255,180/255,233/255), 
               rgb(153/255,150/255,50/255),#235/255,164/255,0), 
               rgb(156/255,85/255,141/255),#186/255,85/255,211/255), 
               rgb(255/255,95/255,24/255))#190/255,71/255,0))  

cbPaletteT <- c(rgb(red,green,blue,.2), 
               rgb(42/255,103/255,236/255,.2),#54/255,90/255,165/255,.2),#86/255,180/255,233/255,.2), 
               rgb(153/255,150/255,50/255,.2), 
               rgb(156/255,85/255,141/255,.2),#186/255,85/255,211/255,.2),  
               rgb(255/255,95/255,24/255,.2))#190/255,71/255,0,.2))


# GWAS plot function

# Linear models
x <- snpMatrix[-naYs, ]
LM <- mfastLmCpp(y = y, x)

# Extract p-values
pVals <- 2*pt(-abs(LM$tstat), df=nrow(x)-1)

# GWAS results
gwasXy <- dataSNP[snpsOfInterest,] %>%
  add_column(pVals = pVals,
             negLogPvals = -log(pVals)) 


snpsOfInterest <- gwasXy$SNPID[(gwasXy$Chr == 10 & 
                                  gwasXy$BPPos > 5 & 
                                  gwasXy$BPPos < 20)]
  

source(file = "/home/ann-sophie/wip/data/mouse/gwasFunctions.R")


######### Only GWAS

plotPrep <-plotPrepFct(gwasXy, snpsOfInterest,  snpsME = NULL, snpsI = NULL) 
  
pdf(paste0("/home/ann-sophie/wip/data/mouse/manPlotWhite",pheno,".pdf"), 
      width = 4, height = 3, pointsize = 11)

par(mar = c(4,4,2,1), oma = c(0,0,0,0))
plotFct(plotPrep, outcomeVar, outer = FALSE, white = TRUE, beamer = TRUE)

dev.off()


######### Also iLASSO

#load(file = "/home/ann-sophie/wip/data/mouse/interactionsStep2")

load(file = paste0("/home/ann-sophie/wip/data/mouse/screenStep1p", pheno))

snpsME <- colnames(X)[MES1]

plotPrep <-plotPrepFct(gwasXy, snpsOfInterest = NULL, snpsOfInterest2 = NULL, snpsOfInterest3 = NULL, 
                       snpsME, snpsI = NULL) 
  
pdf(paste0("/home/ann-sophie/wip/data/mouse/manLasPlotWhite",pheno,".pdf"), 
      width = 4, height = 3, pointsize = 11)

par(mar = c(4,4,2,1), oma = c(0,0,0,0))
plotFct(plotPrep, outcomeVar, outer = FALSE, white = TRUE, beamer = TRUE)

dev.off()


load(file = paste0("/home/ann-sophie/wip/data/mouse/screenStep2Sp", pheno))
snpsME <- S2[[2]]

library(tidyverse)
snpsI <- S2[[1]] %>% 
  strsplit(., ":") %>% 
  unlist %>%
  tibble() %>%
  distinct() %>%
  pull()

plotPrep <-plotPrepFct(gwasXy, snpsOfInterest = NULL, snpsOfInterest2 = NULL, snpsOfInterest3 = NULL, snpsME, snpsI) 
  
pdf(paste0("/home/ann-sophie/wip/data/mouse/manILasPlotWhite",pheno,".pdf"), 
      width = 4, height = 3, pointsize = 11)

par(mar = c(4,4,2,1), oma = c(0,0,0,0))
plotFct(plotPrep, outcomeVar, outer = FALSE, white = TRUE, beamer = TRUE)

dev.off()


@


%
\begin{frame}{}%{\secname}
\transfade
\only<1>{\centering \Large Results: Real Data (work in progress!)}


\only<2>{
  \transfade
  \begin{figure}\centering
  \begin{tikzpicture}
  \node (a) at (0,0)
      {\includegraphics[width=1.0in, keepaspectratio]{/home/ann-sophie/wip/data/mouse/mus.png}};
  %\node[inner sep=0pt, minimum size=.4in] (b) at (0,-3) {$\binom{ \Sexpr{ncol(snpMatrix)}}{2}=\Sexpr{format(choose(ncol(snpMatrix), 2), big.mark = ",")}\quad$};
  %\node[inner sep=0pt, minimum size=.4in] (c) at (3.5,2.5) {Gene-environment interactions};
  \node[inner sep=0pt, minimum size=.4in] (d) at (3.5,2) {Gene-gene interactions};
  \node[inner sep=0pt, minimum size=.4in] (e) at (-1,3) {$p = \Sexpr{ncol(snpMatrix)} \gg \Sexpr{n} = N$};
  \node[inner sep=0pt, minimum size=.4in] (f) at (0,-3) {\small 11K \textsc{snp} micro-array $\leadsto$ 60 million pairwise interactions};
  \node[inner sep=0pt, minimum size=.4in] (g) at (-4,1) {Heterogeneous stock mice\footnotemark};
  \node[inner sep=0pt, minimum size=.4in] (g) at (-4,.5) {($\texttt{\Sexpr{outcomeVar}}$)}; 
  \draw[thick] (a.south) to[out=-90,in=40] (b.north) ;
  \draw[thick] (d.south) to[out=-60,in=80] (a.east) ;
  \draw[thick] (e.south) to[out=-70,in=50] (a.north) ;
  \draw[thick] (g.south) to[out=-70,in=150] (a.west) ;
  \end{tikzpicture}
  \end{figure}
  
  \footnotetext[1]{The Wellcome Centre for Human Genetics, University of Oxford}
}

\end{frame}


\graphicspath{{/home/ann-sophie/wip/data/mouse/}}
\begin{frame}<presentation:0>{}%{\secname}
\transfade
\only<1>{\centering \Large Manhattan Plot}
\only<2>{
  \begin{overlayarea}{\textwidth}{\textheight}
  \begin{figure}
  \centering
  \includegraphics[width=\textwidth]{manPlotWhite10}
  %\only<1>{\includegraphics{PLOTwhitebet12bet1StrongS1100600200}}
  %\only<2>{\includegraphics{PLOTwhitebet12bet1StrongW10100600200}}
  %\only<3>{\includegraphics{PLOTwhitebet12bet1StrongA10100600200}}
  %\only<4>{\includegraphics{PLOTwhitebet12bet1StrongN1100600200}}
  \end{figure}
  \end{overlayarea}
}

% Each point represents a genetic variant. The X axis shows its position on a chromosome, the Y axis tells how much it is associated with the outcome. 

\end{frame}



<<echo = FALSE, eval=FALSE>>=
load(file = "/home/ann-sophie/wip/data/mouse/MEstep1A")
AX <- X
AME <- colnames(AX)[MEs1]
AtME <- tdiff
Ap <- ncol(AX)
load(file = "/home/ann-sophie/wip/data/mouse/MEIstep2A")

load(file = "/home/ann-sophie/wip/data/mouse/MEstep1B")
BX <- X
BME <- colnames(BX)[MEs1]
BtME <- tdiff
Bp <- ncol(BX)

load(file = "/home/ann-sophie/wip/data/mouse/MEstep1C")
CX <- X
CME <- colnames(CX)[MEs1]
CtME <- tdiff
Cp <- ncol(CX)

load(file = "/home/ann-sophie/wip/data/mouse/MEstep1D")
DX <- X
DME <- colnames(DX)[MEs1]
DtME <- tdiff
Cp <- ncol(DX)

allME <- factor(c(AME, BME, CME, DME))
plot(allME, col = "grey", density = 20, border = "grey", yaxt = "n")
axis(side = 2, at = 0:3)


df <- tibble(p = c(Ap, Bp, Cp, Dp),
             tdiff = c(AtME, BtME, CtME, DtME))




@


\begin{frame}
\transfade

\only<1>{
  \centering \Large 2-Step Procedure with screening
}
\only<2>{
Screening based on correlation

  \begin{enumerate}
  \item Calculate all pairwise correlation
  \item Remove features with $\rho > 0.99$ ($\Sexpr{dim(snpMatrix)[2]} \rightarrow \Sexpr{dim(X)[2]}$)
  \end{enumerate}
  
  \hfill
  
Screening based on the global strong rule

  \begin{enumerate}
    \item Calculate the inner product between $X$ and $y$
    \item Define threshold to remove all but $\sim 500$ features
  \end{enumerate}
  
}
\end{frame}


\begin{frame}{}%{\secname}
\transfade
\only<1>{\centering \Large Model assumption: Strong Hierarchy}


\only<2>{
\begin{overlayarea}{\textwidth}{\textheight}
  \begin{figure}
  \centering
  %\only<2>{\includegraphics[width=\textwidth]{manLasPlotWhite10}}
  \only<2>{\includegraphics[width=\textwidth]{manILasPlotWhite10}}
  \end{figure}
  \end{overlayarea}
}

\end{frame}

%
\section{Conclusion}
\subsection{}
%
\begin{frame}{}%{\secname}

\only<1>{
  \centering \Large Conclusion
}

\only<2>{
  \transfade
  \begin{center} Advantages and disadvantages \end{center} 
    \begin{itemize}
      \item[-] Wrong hierarchical assumptions have consequences %regardless of the method
      \item[-] All hierarchical structures can be assumed
      \item[-] Favourable computing times (\texttt{glmnet}) compared to others
        \begin{itemize}
        \item[$\leadsto$] Useful for identifying hierarchical structure
        \item[$\leadsto$] Suitable for G$\times$G, G$\times$E, etc.
        \end{itemize}
      \item[-] Unfavourable computing times (\texttt{glmnet}) for realistic data
        \begin{itemize}
        \item[$\leadsto$] Screening is necessary 
        \end{itemize}
    \end{itemize}
}
\only<3>{
  \transfade
  \begin{center} Future work \end{center}
  \begin{itemize}
  \item[-] More stable screening method
  \item[-] Multivariate set-up
  \item[-] Explore the ``right'' amount of regularisation 
  \item[-] Dependent features
  \item[-] Multi-way interactions
  \end{itemize}
}

\end{frame}


\begin{frame}{}
\centering \LARGE Thank You
\end{frame}



\end{document}